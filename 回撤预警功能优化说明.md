# 回撤预警功能优化说明

## 优化内容概述

根据用户反馈，对回撤预警功能进行了以下三个重要优化：

1. **用户输入合约代码**：添加合约时弹出输入对话框，由用户手动输入合约代码
2. **增加最新价格列**：在监控列表中添加最新价格显示
3. **表格化数据展示**：将中间的回撤信息区改为表格形式，每个合约一行

## 详细优化内容

### 1. 合约输入对话框

#### 新增功能
- **输入对话框**：点击"添加合约"按钮时弹出专用输入对话框
- **合约代码输入**：用户可以手动输入任意合约代码（如BTCUSDT、ETHUSDT等）
- **输入验证**：
  - 检查输入是否为空
  - 自动转换为大写格式
  - 检查是否已存在于监控列表中
- **示例提示**：对话框中显示常用合约代码示例

#### 使用方法
1. 点击"添加合约"按钮
2. 在弹出的对话框中输入合约代码
3. 点击"确定"完成添加
4. 系统会自动验证并添加到监控列表

### 2. 监控列表增强

#### 新增列信息
监控列表现在包含以下列：
- **合约**：合约代码（70px宽度）
- **最新价**：实时最新价格（70px宽度）
- **24h成交额**：24小时成交额，以万为单位（70px宽度）
- **24h涨幅**：24小时涨跌幅，带颜色编码（60px宽度）

#### 颜色编码
- **涨幅**：红色显示
- **跌幅**：绿色显示
- **平盘**：灰色显示

#### 实时更新
- **最新价格**：每5秒更新一次
- **成交额和涨幅**：每5秒更新一次
- **价格波动**：新添加合约会自动设置初始价格，然后进行小幅波动模拟

### 3. 表格化数据展示

#### 布局变化
- **原来**：右侧显示单个选中合约的详细信息
- **现在**：表格形式显示所有合约的回撤信息，每个合约一行

#### 上涨回撤监控表格
包含以下列：
- **合约**：合约代码（60px）
- **最新价**：当前实时价格（70px）
- **最高价**：最近最高价，红色显示（70px）
- **最高价时间**：达到最高价的时间（90px）
- **最大回撤**：历史最大回撤百分比，红色加粗（70px）
- **当前回撤**：当前回撤百分比，橙色显示（70px）
- **回撤分钟**：当前回撤持续分钟数（70px）

#### 下跌回撤监控表格
包含以下列：
- **合约**：合约代码（60px）
- **最新价**：当前实时价格（70px）
- **最低价**：最近最低价，绿色显示（70px）
- **最低价时间**：达到最低价的时间（90px）
- **最大回撤**：历史最大回撤百分比，红色加粗（70px）
- **当前回撤**：当前回撤百分比，橙色显示（70px）
- **回撤分钟**：当前回撤持续分钟数（70px）

#### 表格特性
- **水平滚动**：当列数较多时支持水平滚动
- **行选择**：可以选择特定行查看详情
- **实时更新**：所有数据实时更新，无需手动刷新

## 界面布局优化

### 列宽调整
为了适应新增的最新价格列，对列宽进行了优化：
- 合约列：80px → 70px
- 新增最新价列：70px
- 24h成交额列：80px → 70px
- 24h涨幅列：70px → 60px

### 空间利用
- **监控列表**：保持300px宽度，通过列宽优化容纳更多信息
- **数据展示区**：保持400px宽度，表格形式提高信息密度
- **K线图区**：保持原有布局和功能

## 数据模型增强

### 新增属性
在`DrawdownContractItem`类中新增：
```csharp
public double CurrentPrice { get; set; }  // 当前最新价格
```

### 数据更新逻辑
- **初始价格设置**：新添加合约时自动设置合理的初始价格
- **价格波动模拟**：基于当前价格进行±1%的随机波动
- **回撤计算**：基于最新价格实时计算当前回撤

## 用户体验改进

### 1. 操作流程优化
**添加合约流程**：
1. 点击"添加合约"按钮
2. 输入合约代码（如：BTCUSDT）
3. 系统验证并添加到监控
4. 自动开始数据更新和回撤监控

### 2. 信息展示优化
- **一目了然**：表格形式让所有合约信息一目了然
- **重点突出**：重要数据（回撤）用颜色和加粗突出显示
- **实时性强**：所有数据实时更新，反映最新市场状况

### 3. 交互体验提升
- **输入便捷**：合约输入对话框简洁明了
- **防重复**：自动检查重复合约，避免重复添加
- **即时反馈**：添加成功后立即显示在列表中

## 技术实现要点

### 1. 对话框实现
- **模态对话框**：`ContractInputDialog`确保用户专注输入
- **数据绑定**：使用MVVM模式进行数据绑定
- **输入验证**：前端和后端双重验证确保数据质量

### 2. 表格布局
- **ListView + GridView**：使用WPF标准控件实现表格
- **数据模板**：自定义单元格模板支持颜色和格式化
- **响应式设计**：支持水平滚动适应不同屏幕尺寸

### 3. 数据同步
- **实时更新**：定时器确保数据实时性
- **线程安全**：UI更新在主线程中执行
- **性能优化**：增量更新减少资源消耗

## 示例数据

系统仍然提供示例数据帮助用户快速了解功能：
- **BTCUSDT**：做多监控示例，当前价格44190.00
- **ETHUSDT**：做空监控示例，当前价格2834.50

## 使用建议

### 1. 合约选择
- 选择流动性好的主流合约（如BTCUSDT、ETHUSDT）
- 避免添加过多合约影响系统性能
- 根据交易策略选择做多或做空监控

### 2. 回撤阈值
- **轻度回撤**：0-3%，正常波动
- **中度回撤**：3-8%，需要关注
- **重度回撤**：8-15%，高风险警告
- **极度回撤**：>15%，建议立即处理

### 3. 监控策略
- 定期检查表格中的回撤数据
- 关注最大回撤和当前回撤的变化
- 结合K线图分析制定应对策略

## 后续优化方向

1. **数据源集成**：接入真实的交易所API
2. **预警功能**：添加回撤阈值预警通知
3. **历史记录**：保存历史回撤数据用于分析
4. **导出功能**：支持数据导出到Excel
5. **自定义列**：允许用户自定义显示列和顺序

这次优化显著提升了回撤预警功能的实用性和用户体验，使其更加贴近实际交易需求。 