# 回撤预警自选列表本地保存功能测试指南

## 测试目标
验证回撤预警窗口中的自选列表能够正确保存到本地文件，并在程序重启后正确加载。

## 测试环境准备

### 1. 编译项目
```bash
cd TCClient
dotnet build
```

### 2. 运行程序
```bash
dotnet run
```

## 详细测试步骤

### 测试1：基本添加和保存功能

#### 步骤：
1. 启动程序，打开"回撤预警"窗口
2. 点击左侧"添加做多合约"按钮
3. 输入合约代码，例如：`BTCUSDT`
4. 确认添加
5. 点击右侧"添加做空合约"按钮
6. 输入合约代码，例如：`ETHUSDT`
7. 确认添加

#### 预期结果：
- 合约成功添加到对应列表中
- 控制台输出保存成功的调试信息
- 文件 `%APPDATA%\TCClient\drawdown_watchlist.json` 被创建

#### 验证方法：
打开文件资源管理器，导航到：
```
%APPDATA%\TCClient\
```
查看是否存在 `drawdown_watchlist.json` 文件，并检查内容格式是否正确。

### 测试2：程序重启后数据恢复

#### 步骤：
1. 在测试1的基础上，关闭程序
2. 重新启动程序
3. 打开"回撤预警"窗口

#### 预期结果：
- 之前添加的做多合约（BTCUSDT）出现在左侧列表中
- 之前添加的做空合约（ETHUSDT）出现在右侧列表中
- 控制台输出加载成功的调试信息

### 测试3：删除合约功能

#### 步骤：
1. 在回撤预警窗口中选择一个做多合约
2. 点击"删除做多合约"按钮
3. 选择一个做空合约
4. 点击"删除做空合约"按钮

#### 预期结果：
- 选中的合约从列表中移除
- 本地文件立即更新
- 控制台输出删除和保存的调试信息

### 测试4：多个合约管理

#### 步骤：
1. 添加多个做多合约：`BTCUSDT`, `ETHUSDT`, `BNBUSDT`
2. 添加多个做空合约：`ADAUSDT`, `XRPUSDT`, `SOLUSDT`
3. 关闭程序并重启
4. 验证所有合约都正确加载

#### 预期结果：
- 所有合约都能正确保存和加载
- 列表顺序保持一致
- 没有重复或丢失的合约

### 测试5：异常情况处理

#### 测试5.1：文件损坏恢复
1. 手动编辑 `drawdown_watchlist.json` 文件，破坏JSON格式
2. 重启程序
3. 验证程序能正常启动，使用空列表

#### 测试5.2：文件权限问题
1. 将 `drawdown_watchlist.json` 文件设置为只读
2. 尝试添加新合约
3. 验证程序不会崩溃，有适当的错误处理

#### 测试5.3：目录不存在
1. 删除整个 `%APPDATA%\TCClient\` 目录
2. 重启程序
3. 添加合约
4. 验证目录和文件能自动创建

## 调试信息验证

### 控制台输出示例
程序运行时应该看到类似以下的调试信息：

#### 启动时加载：
```
已加载回撤预警自选列表: 做多 2 个, 做空 1 个
```

#### 添加合约时：
```
已添加做多合约: BTCUSDT
回撤预警自选列表已保存: 做多 3 个, 做空 1 个
回撤预警自选列表已保存到: C:\Users\[用户名]\AppData\Roaming\TCClient\drawdown_watchlist.json
```

#### 删除合约时：
```
已移除做多合约: BTCUSDT
回撤预警自选列表已保存: 做多 2 个, 做空 1 个
```

## 文件内容验证

### JSON文件格式检查
打开 `drawdown_watchlist.json` 文件，内容应该类似：

```json
{
  "LongContracts": [
    "BTCUSDT",
    "ETHUSDT",
    "BNBUSDT"
  ],
  "ShortContracts": [
    "ADAUSDT",
    "XRPUSDT"
  ],
  "LastUpdated": "2024-01-15T10:30:00.000Z"
}
```

### 验证要点：
- JSON格式正确，可以被解析
- 合约名称都是大写
- 时间戳格式正确
- 数组中没有重复项

## 性能测试

### 大量合约测试
1. 添加20个做多合约
2. 添加20个做空合约
3. 验证保存和加载性能
4. 检查内存使用情况

#### 预期结果：
- 保存操作在100ms内完成
- 加载操作在200ms内完成
- 内存使用增长合理（每个合约约2KB）

## 兼容性测试

### 不同用户账户
1. 在不同的Windows用户账户下运行程序
2. 验证每个用户都有独立的配置文件
3. 确认文件路径正确

### 中文合约名称
1. 尝试添加包含中文字符的合约（如果支持）
2. 验证编码处理正确
3. 确认文件保存和读取正常

## 故障排除

### 常见问题及解决方案

#### 问题1：文件未创建
- **原因**：可能是权限问题或路径错误
- **解决**：检查 `%APPDATA%` 目录权限，确保程序有写入权限

#### 问题2：数据未加载
- **原因**：JSON文件格式错误或编码问题
- **解决**：删除配置文件让程序重新创建，或手动修复JSON格式

#### 问题3：程序启动慢
- **原因**：文件读取阻塞或网络超时
- **解决**：检查文件大小，确认异步加载正常工作

#### 问题4：合约重复
- **原因**：大小写处理或去重逻辑问题
- **解决**：检查代码中的字符串比较逻辑

## 测试报告模板

### 测试结果记录
```
测试日期：____年__月__日
测试人员：__________
程序版本：__________

基本功能测试：
□ 添加做多合约 - 通过/失败
□ 添加做空合约 - 通过/失败
□ 删除合约 - 通过/失败
□ 程序重启恢复 - 通过/失败

异常处理测试：
□ 文件损坏恢复 - 通过/失败
□ 权限问题处理 - 通过/失败
□ 目录自动创建 - 通过/失败

性能测试：
□ 大量合约处理 - 通过/失败
□ 保存速度 < 100ms - 通过/失败
□ 加载速度 < 200ms - 通过/失败

发现的问题：
1. ________________________
2. ________________________
3. ________________________

总体评价：□ 优秀 □ 良好 □ 一般 □ 需改进
```

## 自动化测试建议

### 单元测试
为 `DrawdownWatchlistService` 类创建单元测试：
- 测试文件读写操作
- 测试异常处理
- 测试数据验证

### 集成测试
测试 ViewModel 与 Service 的集成：
- 测试数据绑定
- 测试命令执行
- 测试事件处理

通过以上测试步骤，可以全面验证回撤预警自选列表本地保存功能的正确性和稳定性。 